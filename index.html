<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Antrean - BPJS Kesehatan Live</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --g1:#eaf6ff;
      --g2:#f0e9ff;
      --g3:#fff0f7;
      --accent-1:#7ad7ff;
      --accent-2:#9a7bff;
      --text:#15303b;
    }

    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      margin: 0;
      font-family: "Nunito", system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color: var(--text);
    }

    body {
      background:
        radial-gradient(800px 400px at 10% 20%, rgba(122,215,255,0.18), transparent 8%),
        radial-gradient(700px 350px at 90% 80%, rgba(154,123,255,0.10), transparent 10%),
        linear-gradient(135deg, var(--g1), var(--g2) 55%, var(--g3));
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px;
    }

    .login-card {
      width: 420px;
      padding: 32px 28px;
      border-radius: 18px;
      background: rgba(255,255,255,0.95);
      box-shadow: 0 12px 40px rgba(18,30,50,0.1);
      text-align: center;
    }

    .logo { width: 100px; margin: 0 auto 20px; }

    .login-title {
      font-size: 28px;
      font-weight: 800;
      margin: 10px 0 22px;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid rgba(12,30,40,0.08);
      background: #fff;
      border-radius: 12px;
      font-size: 15px;
      margin-bottom: 18px;
    }

    .btn-grad {
      padding: 10px 16px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      color: #fff;
      font-size: 15px;
      font-weight: 800;
      cursor: pointer;
    }

    .panel-wrap {
      width: 100%;
      max-width: 1200px;
      display: none;
      flex-direction: column;
      gap: 14px;
    }

    .panel-card {
      background: rgba(255,255,255,0.9);
      padding: 16px 18px;
      border-radius: 12px;
      box-shadow: 0 8px 26px rgba(8,18,30,0.04);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 10px 14px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .row-select { padding: 6px 8px; border-radius: 8px; }
    .row-save {
      padding: 8px 10px;
      border-radius: 9px;
      background: linear-gradient(90deg, var(--accent-1), var(--accent-2));
      color: #fff;
      border: none;
      font-weight: 800;
      cursor: pointer;
    }

    .msg { margin-top: 8px; font-weight: 800; color: green; }

    @media(max-width: 768px){
      .panel-wrap { width: 95%; }
      .login-card { width: 92%; padding: 24px; }
      table { font-size: 13px; }
    }
  </style>
</head>

<body>

  <div id="loginCard" class="login-card">
    <img src="./logo-dashboard.png" class="logo" />
    <div class="login-title">Login Admin</div>

    <input id="adminPass" class="input" type="password" placeholder="Masukkan password admin">
    <button class="btn-grad" onclick="attemptLogin()">Masuk</button>

    <div id="loginHint" class="hint">Masukkan password untuk membuka panel admin.</div>
  </div>

  <div id="panelWrap" class="panel-wrap">

    <div class="panel-card">
      <h2>Antrean - BPJS Kesehatan Live</h2>
      <div class="top-btns">
        <button class="btn-grad" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="panel-card">

      <div class="top-btns">
        <button class="btn-grad" onclick="loadTable()">ðŸ”„ Refresh</button>
        <button class="btn-grad" onclick="saveAll()">ðŸ’¾ Simpan Semua</button>
      </div>

      <table id="queueTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Nama Peserta</th>
            <th>Alamat Email</th>
            <th>No Whatsapp</th>
            <th>Nomor</th>
            <th>Jenis</th>
            <th>Loket</th>
            <th>Status</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="7" style="text-align:center;padding:22px;color:rgba(0,0,0,0.45)">
              Memuat data...
            </td>
          </tr>
        </tbody>
      </table>

      <div id="panelMsg" class="msg"></div>
    </div>

  </div>

  <script>
  const ADMIN_PASS = "bpjs2025";
  const SHEET_ID = "120UsoqLcw4eZZCLjd2z90mPKRRXKdC8DBjn-9ImRzfE";
  const OPENSHEET_BASE = "https://opensheet.elk.sh";

  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyHOAYQ9D3MyPLdFM80gBnPT6zyPIZMELldBIqCJ2NBbndYLqApPAt_EdYNjQH5FvFHfg/exec";

  const todayStr = new Date().toISOString().slice(0,10);
  const DATA_SHEET_NAME = todayStr;

  let currentRows = [];

  /* LOGIN SYSTEM */
  function attemptLogin(){
    if (adminPass.value.trim() === ADMIN_PASS){
      loginCard.style.display = "none";
      panelWrap.style.display = "flex";
      loadTable();
    } else {
      loginHint.textContent = "Password salah â€” coba lagi.";
      loginHint.style.color = "crimson";
      setTimeout(()=>{
        loginHint.textContent = "Masukkan password untuk membuka panel admin.";
        loginHint.style.color = "";
      },2200);
    }
  }

  adminPass.addEventListener("keypress", e=>{
    if(e.key==="Enter") attemptLogin();
  });

  function logout(){
    panelWrap.style.display="none";
    loginCard.style.display="block";
    adminPass.value="";
  }

  /* FETCH DATA */
  async function fetchSheet(name){
    const res = await fetch(`${OPENSHEET_BASE}/${SHEET_ID}/${name}`);
    return res.json();
  }

  /* RENDER TABLE */
  function renderRows(rows){
    currentRows = rows;
    tableBody.innerHTML = "";

    rows.forEach((r,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${r['Nama Lengkap']||'-'}</td>
        <td>${r['Alamat Email']||'-'}</td>
        <td>${r['No Whatsapp']||'-'}</td>
        <td>${r['Nomor Antrean']||'-'}</td>
        <td>${r['Jenis Layanan']||'-'}</td>

        <td>
          <select id="loket-${i}" class="row-select">
            ${[1,2,3,4,5].map(n=>`
              <option ${r['Loket']==`Loket ${n}`?'selected':''}>Loket ${n}</option>
            `).join("")}
          </select>
        </td>

        <td>
          <select id="status-${i}" class="row-select">
            <option ${/menunggu/i.test(r['Status Antrean'])?'selected':''}>Menunggu</option>
            <option ${/sedang/i.test(r['Status Antrean'])?'selected':''}>Sedang Dilayani</option>
            <option ${/selesai/i.test(r['Status Antrean'])?'selected':''}>Selesai</option>
          </select>
        </td>

        <td><button class="row-save" onclick="saveSingle(${i})">Simpan</button></td>
      `;
      tableBody.appendChild(tr);
    });
  }

  async function loadTable(){
    showMsg("â³ Memuat data...", "#555");
    const data = await fetchSheet(DATA_SHEET_NAME);
    renderRows(data);
    showMsg("âœ” Data hari ini berhasil dimuat","green");
  }

  /* =============================
        FIX BAGIAN SAVE !!!
  ==============================*/

  async function saveSingle(i){
    const nomor = currentRows[i]["Nomor Antrean"];   // FIXED
    const status = document.getElementById(`status-${i}`).value;
    const loket  = document.getElementById(`loket-${i}`).value;

    await saveToAPI({ nomor, status, loket });
  }

  async function saveAll(){
    const updates = currentRows.map((r,i)=>({
      nomor: r["Nomor Antrean"],   // FIXED
      status: document.getElementById(`status-${i}`).value,
      loket:  document.getElementById(`loket-${i}`).value
    }));

    await saveToAPI({ updates });
  }

  /* SEND TO WEB APP */
  async function saveToAPI(body){
    try {
      showMsg("Menyimpan...", "#555");

      await fetch(SCRIPT_URL,{
        method:"POST",
        mode:"no-cors",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(body)
      });

      showMsg("âœ”ï¸ Data berhasil disimpan","green");
    } catch {
      showMsg("âŒ Gagal menyimpan (cek Web App)","crimson");
    }
  }

  function showMsg(txt,color="green"){
    panelMsg.textContent = txt;
    panelMsg.style.color = color;
    setTimeout(()=>{
      if(panelMsg.textContent===txt) panelMsg.textContent="";
    },3000);
  }

</script>

</body>
</html>
